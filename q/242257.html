<!DOCTYPE html>
<html>
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6EBTM9J4LK"></script>
<script src="../g.js"></script>
    <title>cg::242257</title>
    <link rel="stylesheet" href="../c.css">
</head>
<body>
    <br><br>
    <div id = "content">
    <div id="container">
    <div id="mf">
        <a href="#" class="nonewtab" d-g="g">g</a> | 
        <a href="#" class="nonewtab" d-g="x">x</a> | 
        <a href="#" class="nonewtab" d-g="w">w</a> | 
        <a href="#" class="nonewtab" d-g="">all</a>
    </div>
    <input type="text" id="mi" placeholder="/">
    </div>

<table id="mt">
  <tr class="header">
    <th class="tbytes">Bytes</th>
    <th class="tlang">Lang</th>
    <th class="ttime">Time</th>
    <th class="tlink">Link</th>
  </tr>
<tr d-ix="0"><td>476</td><td>tinylisp</td><td>250203T193149Z</td><td><a href="https://codegolf.stackexchange.com/questions/242257/ungolf-my-tinylisp-code/278040#278040">Mukundan</a></td></tr>
<tr d-ix="1"><td>255</td><td>Python</td><td>250202T050524Z</td><td><a href="https://codegolf.stackexchange.com/questions/242257/ungolf-my-tinylisp-code/278024#278024">Mukundan</a></td></tr>
<tr d-ix="2"><td>1022</td><td>tinylisp</td><td>220513T114552Z</td><td><a href="https://codegolf.stackexchange.com/questions/242257/ungolf-my-tinylisp-code/247238#247238">emanresu</a></td></tr>
<tr d-ix="3"><td>388</td><td>Python 3</td><td>220203T050831Z</td><td><a href="https://codegolf.stackexchange.com/questions/242257/ungolf-my-tinylisp-code/242264#242264">DialFros</a></td></tr>
<tr d-ix="4"><td>330</td><td>Retina 0.8.2</td><td>220204T014701Z</td><td><a href="https://codegolf.stackexchange.com/questions/242257/ungolf-my-tinylisp-code/242328#242328">Neil</a></td></tr>
<tr d-ix="5"><td>166</td><td>Charcoal</td><td>220205T114931Z</td><td><a href="https://codegolf.stackexchange.com/questions/242257/ungolf-my-tinylisp-code/242390#242390">Neil</a></td></tr>
<tr d-ix="6"><td>629</td><td>Python3</td><td>220203T025703Z</td><td><a href="https://codegolf.stackexchange.com/questions/242257/ungolf-my-tinylisp-code/242260#242260">Ajax1234</a></td></tr>
</table>
<div id="pu0" class="pu"><h1><a href="https://github.com/dloscutoff/Esolangs/tree/master/tinylisp" rel="nofollow noreferrer">tinylisp</a>, <sup><s>493</s> ... <s>477</s></sup> 476 bytes</h1>
<p><em>-2 bytes thanks to <a href="https://codegolf.stackexchange.com/users/16766/dlosc">@DLosc</a></em><br />
<em>-4 bytes thanks to <a href="https://codegolf.stackexchange.com/users/100664/emanresu-a">@emanresu A</a> by making the entrypoint an anonymous lambda</em></p>
<pre><code>(load library
(d I(q((L)(i L(c(h L)(_repeat-val 32(e(h L)10)(I(t L))))(q(41
(d R(q((N L)(c(c N(h L))(t L
(d W(q((L A)(i(contains?(q(32()40 41))(h L))(R(reverse A)(E L))(W(t L)(c(h L)A
(d {(q((D L)(c D(I(c 40(t(concat(h L)(i(t L)(c(i(l(h(h(t L)))3)32 10)(chars(join(map string(map t(t L)))(i(l D 4)spc nl))))(
(d }(q((L)(R({(+(h(max(c(q(0))(h L))))1)(h L))(E(t L
(d E(q((L)(i(e(h L)32)(E(t L))(i(e(h L)40)(}(E(t L)))(i(-(h L)41)(W L(q(1)))(c()(t L
(q((S)(string(t(h(h(E(chars S
</code></pre>
<p><a href="https://tio.run/##xVNNb9swDL3nV/BIYShg2XIXn4oCyaFA0UN6yHHQVG9x4TiJLRQriv72jKQkJ@khKbYBS2yI5sfjezTtm@61bYbtfo/txj5B23zvbf86wSe4wx3ivcIG7tHhCsj81tfb2vqrF9tCkWMtXp0pvENPFv2oxmiuXnD1Axc5dPAgmYqzOLgUaLglcHSbztumG27IR5jKZGA0pYaCBfb1S90PNSfPxbWUXpHSLcO9MdxMnDAjLg5Mhp6RnfWBeZOKGmxxRf/At1BFDizArWw/4POm6XBttzD4vul@iuljKlfCDIwatg66VsRy8/c4pgW@4RcCXttf1GaHWdKglE5q5mkA8zTbOMMij0F18Bmi9Z687L4KbkJb0ivZoWa3wzhVAnxUGIl70TgPsuBx37Xc9cemX1sPMXWMKoKYTDBFAwQgrYWnQdJ4MnrZcF3Jgy74EItfVEgowzHlPPbTUY5RXfKzqVIwuBNceVJDimi2Z8jwakjKGbpTwtNQfU3MxUMcKw4YCdCh88tQUWx1Qu5iulQElZ8rIvSCeph4VfmloqPr8sTGHjKcZFXVRyNmiQod5pasP8hn/UfXScn/JDIu0PmF15mmOw9oZOppPGlzDxqmYcsqWS2qoqdEie8QO6jPwrcSwMpDH/oIAmiZpa/hqPiY9Kc5ax1df8NXnMzv@h8oGEXsfwM" rel="nofollow noreferrer" title="tinylisp – Try It Online">Try it online!</a></p>
<p>A port of <a href="https://codegolf.stackexchange.com/a/278024/91267">my python answer</a>. Doesn't use tail-call recursion in some places so fails for the larger inputs.</p>
<h3>Ungolfed</h3>
<pre class="lang-lisp prettyprint-override"><code>(load library)

(def return (lambda (el res) (cons (cons el (head res)) (tail res))))

(def return-wrap (lambda (res)
  (return
    (wrap (+ (head (max (cons (list 0) (head res)))) 1) (head res))
    (expr (tail res)))))

(def indent (lambda (ls)
 (if ls
  (cons (head ls) (_repeat-val 32 (equal? (head ls) 10) (indent (tail ls))))
  (list 41))))

(def wrap (lambda (depth ls)
 (cons depth (indent (cons 40
   (tail (concat
    (head ls)
    (if (tail ls)
     (cons
      (if (less? (head (head (tail ls))) 3) 32 10)
      (chars (join (map string (map tail (tail ls))) (if (less? depth 4) spc nl))))
     ()))))))))

(def sym (lambda (ls accum)
  (if (contains? (list () 32 40 41) (head ls))
    (return (reverse accum) (expr ls))
    (sym (tail ls) (cons (head ls) accum)))))

(comment returns (((depth ungolfed...) (depth ungolfed...) ...) remaining))
(def expr (lambda (ls)
  (if (equal? (head ls) 32)
    (expr (tail ls))
    (if (equal? (head ls) 40)
      (return-wrap (expr (tail ls)))
      (if (- (head ls) 41)
    (sym ls (list 1))
    (cons () (tail ls)))))))

(comment entrypoint)
(lambda (str) (string (tail (head (head (expr (chars str)))))))
</code></pre>
</div>
<div id="pu1" class="pu"><h1><a href="https://www.python.org" rel="nofollow noreferrer">Python</a>, <sup><s>270</s> <s>263</s></sup> 255 bytes</h1>
<p><em>- 8 bytes thanks to <a href="https://codegolf.stackexchange.com/users/16766/dlosc">@DLosc</a> by storing <code>t.pop</code> in a variable</em></p>
<pre class="lang-python prettyprint-override"><code>def f(t,E=[]):
 p=t.pop;t[0]&lt;&quot;!&quot;&lt;p(0);r=&quot;&quot;
 while(t[0]in&quot;() &quot;)&lt;1:r+=p(0)
 if r:E+=1,;return r
 t+=&quot;)&quot;;p(0);D,*R=[0],
 while&quot;)&quot;!=t[0]:R+=f(t,D),
 d=max(D);n=&quot;\n &quot;;r,*R=R or[&quot;&quot;];E+=d+1,;return&quot;(&quot;+(r+(R and n[D[2]&lt;3]or&quot;&quot;)+n[d&lt;3].join(R)).replace(&quot;\n&quot;,n)+p(0)
</code></pre>
<p><a href="https://ato.pxeger.com/run?1=pVXNbuM2EL71oKeY5aXDyjXk7KWIow0WyRYo0EPjBXLx-qBEVKJCphiKTm2_QB-il1zap-iLbF-mnSEpWc1P06KCZZPffPP3cSz98pvZudtWPzz8unHV1998_rNUFVToJh_y5UoeJ2ByNzWtmbtltjoRb8SJwUzObS5EAj_d1o1CttRaoAQhT2bHNs2ZkkBdgT3-kOazydwqt7EabAIuzYUUcx_kfPLVIifnSYxEhjc5RztepDnXcC7JVObrYovncq5z8UmDmFt2W0Brl0Ks5pSgTIcUAkWKNsUFFLoEvTxfHq1O3q5aK4RM9bKk9fTHtta4kHJqlWmKa4UUVky0TLmoKMPvVWvBqc5dF52CWkNrlCYz-RQlymlnmtqxI7mySnTV2kxAbQ3ksC4Mds5O6a4J7OP0Xvk7IaX3aTeO6BU2deeQAhDscWNr7XApvn3_3fdiAuKH9x8_itXS03NOspIjHsHjbezh4Y8vfkaZ5O8S-k6waYsSmvrKFnbnwTHAhDucwZG33AEvZQBxJjHCCfAOkEzeBl8KIT5FF79mmC-P8SVl4JZwxrEu4FJiDRdYYwMXkMmMdpdY4Bl2hN6SWRLjjNaO1zKTcuaDUQBKTyVAiML9ciTfNy1iPL-FLPxw7LACLOIC8KxfAeeEkHTALuWByNZQRsSyuJrFrlipG8Br_7mDOwk38snWSwD_nhqOLLR649u8Dk0emHEfu3yExzC9Wv8jRDi4ig9uCzvYg-HDM_7wDImBFSm4JXSHhbdmbN9GmOamIK-Z3NPWsGZk3GFFhM7j3ol-eitZfJaMU1NJW7p3dO8xTkA1TEBfTpwCM5oCM0wBBYz1ETtWeDBSof1sRB6PdqiYqH1VPYdKHwaDC409QGziMR_-3k2v_nbQe8df-17oIDU9edW90qfURrG-KgtAvVlT6LK-r0vVncIRMBAnZKAnr_MDuy3LJ7F1655xOGRgn0cJ-ARecgtOg2HwY6SjR-p607jaNIoy0-sBtbopXH2vTiESxtWz9YC_6DkyDK59Oh9iIETXRnXdwW2Uea9s-0q8bnN19NR19L8dt5_8Q_8s4vMK-Jl-TYQw-M_rEIbtNS3iX-ZlPeKoPhIlov9NmfBC-gs" rel="nofollow noreferrer">Attempt This Online!</a></p>
<h3>Commented Version</h3>
<pre class="lang-python prettyprint-override"><code>def f(t, E=[]):  # E = return variable for depth
    # remove first element of t if it is ' '
    t[0] &lt; &quot;!&quot; &lt; t.pop(0)

    # read into r from t till '(', ')' or ' '
    r = &quot;&quot;
    while (t[0] in &quot;() &quot;) &lt; 1:
        r += t.pop(0)

    # if r is not empty (i.e. r contains a symbol or integer) return depth=0+1, r
    if r:
        E += 1,
        return r

    # Remove first element of t (which must equal '(')
    t.pop(0)

    # add a extra ')' to end in case there isn't enough ')'
    t += &quot;)&quot;

    # D = list for storing depths returned by child elements
    # R = list for storing ungolfed versions of child elements
    D, *R = [0],
    while &quot;)&quot; != t[0]:  # while current expression isn't at its end
        # add child element with recursive call
        R += f(t, D),

    # depth of current expression is maximum of depth returns from elements
    d = max(D)

    n = &quot;\n &quot;

    # extract first element into r keep rest in R
    r, *R = R or [&quot;&quot;]

    E += d + 1,                             # return (depth = d + 1)
    return (                                # return
        &quot;(&quot;                                 # &quot;(&quot; +
        + (
            r                               #   first element
            + (R and n[D[2] &lt; 3] or &quot;&quot;)     #   + (&quot;&quot; if only one element otherwise &quot;\n&quot; or &quot; &quot; depending on depth of second element)
            + n[d &lt; 3].join(R)              #   + rest of R joined with &quot;\n&quot; or &quot; &quot; depending on depth
        ).replace(&quot;\n&quot;,n)                   # increase indent
        + t.pop(0)                          # + &quot;)&quot;
    )
</code></pre>
</div>
<div id="pu2" class="pu"><h1><a href="https://github.com/dloscutoff/Esolangs/tree/master/tinylisp" rel="noreferrer">tinylisp</a>, 1022 bytes</h1>
<pre><code>(load library
(d ? contains?
(d r reverse
(d O last
(d _(q((S T C)(i S(i(e(h S)32)(_(t S)(i C(c(r C)T)T)())(i(?(q(40 41))(h S))(_(t S)(c(h S)(i C(c(r C)T)T))())(_(t S)T(c(h S)C))))(r(i C(c(r C)T)T
(d @(q((T A D)(i T(@(t T)(c(+(w T)D)A)(+(w T)D))(r(c(+(w T)D)A
(d w(q((T)(-(e(h T)40)(e(h T)41
(d #(q((T A)(i A(#(c 41 T)(- A 1))(r T
(d E(q((T)(max(@ T()0
(d p(q((L A)(i A(p(c 32 L)(- A 1))L
(d n(q((D T A)(i(l 0(h D))(n(t D)(t T)(c(h T)A))(r(c(h T)A
(d N(q((T)(n(@ T()0)T(
(d H(q((T A)(i T(i(*(e(h T)40)(e(cadr T)41))(H(t(t T))(c(q(40 41))A))(H(t T)(c(h T)A)))(r A
(d W(q((L)(i(c()L)L(c L(
(d :(q((I L)(i I(:(- I 1)(t L))L
(d ;(q((L)(:(s(last-index(r(@(r L)()0))1)1)L
(d }(q((D T)(i(l 0(h D))(}(t D)(t T))(t T
(d f(q((T S P)(i T(f(t T)(concat S(i(e(h T)41)(c 41())(i(+(l(E(N(concat(; P)T)))3)(*(not((q((T)(}(@ T()0)T)))(t(; P))))(l(E(N T))2)))(p(W(h T))(- 1(?(q(()40))(O P))))(i(e(O P)40)(W(h T))(c 10(p(W(h T))(O(@ P()0))))))))(insert-end(h T)P))S
(d F(q((S)(string(f(H((q((T)(#(r T)(last(@ T()0)))))(_(chars S)()()))())()(
</code></pre>
<p><a href="https://tio.run/##zVVNT@MwEL3zKyxxGe@qku2mJYEDrfgQSBUgNRJHlE3LEqmk3TRa4MBv786M7XwUaLuLVrsttOPxzHvzxuO0zPKXWbZcrFYwmycTMcu@FUnxsgcTcSzSeV4mWb48pmUhiunPabGc0uJazJJlSdYd/AAYi1icSMjEGDKYwoMYy66RcAclWug@gRQKjIjxDRI9cIxpgRKBxhWFV8EpL9dyOMkGxC7iROILinYgFTSggmIxFKeEEsMA02LC/QpPaJzKoaxMAmhsUPoTp0vosI5YBkp6S9P@voMn8CHsQ4oaCL@DjCSmEFzFmYN5TJ5hgFVIRd4FeUc@eYHJXSNGVfKIYnKKORWWAmZCITlVmqMOlOTEUEFDVz/blHrlSHNHic0i90Wj5Bgxv7SkpcmkYHWIdgElExBDdT5Du9HiJZ1MecuKqNIU5EiOUNKISQ9p45LEZeISDlHiJUpEmJHTeeQyD2EJNEydLJ9Mn1HQALHRj@VLjW8OfnVNabfktW4Jf1LkvRU7FjdW7r2rfJ6nSVnNJ@vls7Pj@BVmcAZXLgyOMBsxZVdis/J5Ca6xr1VjqQU2jixOpioMrRZwyxR0rponHajXEq5dONVANh2AD02FVo3Ma2S64R7YF@A1nBZlZ5pPOAKBxiT3nK@fhGVZZPl3VHvha92nUZTcWl81A91B@pAUS7pkdK34aklYUevmxSP26Fzu7e2BWzhgAfiQKIWbCPnxtlah0FqL6ABNRePNHtUTEW0EvIFf2mzB0V1miwiip3aK5XC8jWjskIG4XUQP3F9kNmY0/ihuUwNYdf@gXVmoyRv2XX3UEFpXC9c668PPIOTIsBncp0XEwB6@hRI0KHTNhbF1kO63ghyHNaLNyuq@MZu3omjdcFEsXtsR8NYfxNeF6tr5HxRiL8L2SdDKtEdBG@s3lsIYy2nao8GO9dkgZz0cqsa2KQ7YQhG@nZe3LOEal1EfolVXygPp2kuojQRXXOQb1MCvqm2w6d4bwPV6K@8mCtPU3mpqPdo@2h61q8AvWjtmpxuula6YydSh@8brVk9maB@DET/7lNfGcujf7tUzrWzDLFiv5kHtFrTnzreVXI3izgVr7VyfKZad2j9QPlm@v0y793wb1xZJ6/m659QEFj5yJYYs0Ib4n7LmY4i5TbMnXGTX/sz1GyTaFbaJ@jdGYY1uJ@C/K2tn7G3SthzOe8q3cn8kTYUVebOAzXg7n6LxT4eAN/9Jp3pMhhfA3b5Pa3vvZ3D1Cw" rel="noreferrer" title="tinylisp – Try It Online">Try it online!</a></p>
<p>This took several <s>hours</s> days, but now it actually works.</p>
<p>This emits a couple of errors, which I think are unavoidable, and now a lot more which are avoidable.</p>
<p>-18 thanks to DLosc.</p>
<p>Because tinylisp doesn't have string literals, you'll need to pass your input through <a href="https://tio.run/##hY1BDoIwEEX3nGLChpmNC9254SgGaMEx0JJ2IEHj2bEIAokxdtX8@e/9dpCrNadxVLoEsRdhM9TsW/Ti2FR0jgDAaemcgTJeUsBQEXgkkBxuls0Uo3UKC6LSOiiADSyCJ1EcRW34C@79MU6LintW2qfBmDW5ygCnxAdH09XCba0JkEtAo6tMuNcpLAWaqzMcrlv@k9wdVvQz91ashQWttfcbtlu@a2f/@HyXH7/R@cVE4/gC" rel="noreferrer">this python script</a>.</p>
<p><a href="https://tio.run/##zVhLb@M2EL77V7CnSl0YEOVHrF6C3nvsvWBkOhIiS67EbJJfnw7JITmUZMvpomgBryORw5lvPs7Lq@r2o6mHy@dn0nTiyJr6qRf9R7pKyu58lq1aMaa6F9myQQklf2W/gcigWHdiyaD6un222wMrX/se5NfmNYVjf4gXOTDh5ctK9AN7kqV4HSRTVQffopdMiqGWPahhb13/wt5qVaWrVXKUJ/Yn6k4acX46CmOS2gvGkvoECHt4ss8Av1WibodHOKwBbHLGs5QllRZLUyNoRYMiXIRlb1gZcaMO3nr5XfYAm9hGOCDilc6cd69pZHkCcpuxLZ@AvApzaohsMQe6mu6wOxwa6Yrer/FTUW9T6u4NTqKjBIg77EAuXNmiQ17UOagNYJyVR3lRVYgzxGZXRVmmDGPMblhc/pTyHjMH8hueTd6quqzWFwj0dswsQr4paozP86BPB/fvMcistuA3lR35bj1eW8vyr1fRPOrwhHuKlPotTrcos9350kglJ9yKc/faKk@sfXXE@kOGIlDuQ2qNkoyPaCHG0fY109YmMTLSoOUhGf39IuDMxHNQL98v/Xo2bkxBOnXNsWFn8Z6jF9mixgsUYK@q8RRNGWKJETVqobA1s8To5XAPrXxXaw15PsgHExpoKWmYuWm743imKkLEwyOK@diHgiZ7kGyPJCZoIN8Q8ICv4jUgCRZXRua4tfw6CirRHhu5butmGozBeZrh9cn59EvINIx4gnybpdPtUhz7IMFD1kc4FOHSl1HaCwJt06P@DlwJjamM0yOm91lipx5oxGFmBCsrrDQ2U1ajSt7ojmY4joh@68Xlp0itiyv1cZGP@tjv4KHF1yDVxufGpS8OHyyJcGqR4oEVB1YUmh94huj3r1AmNM/@vk9dfxZqctd6hqjbo1Z/AXLWJKwm1z972zzchzMR7oL07BDlgCzqwZCsiICnsweIOYqRDA8k4GBgkj3tzo0c9EhBCxRJJwiWUmMemrqUkfpQQtkmavdPnaricaAe1oMETccxh/fC8DGfx0PCDUaZx@4mPb9uyiHGXTU/wRjW@WiJTWewxOQz9oCI/DSegb65O5yvCJHs/Vf7FQ7Y6E5OUaeeOjDmY5EwU1d4xqaszRM@7pzEemh2ETFiJhHu4wv1mEHZpfw44zHp3C@VwCwtK/Z3idGjL9/hRJUmS9anvjtHrVmjfnc1w7zYkkHFlWvMZt/3ZduW9ROxMCmXRJErkYPvsJrltdUawiYeD@MJ1TUBDSijcznSzmmf7OW5@w7lf2FiWJgWplrmhgaUVtPpbQmFnQMmUrfGgXTltYf6Nae27ZTmbOoAFk1SEW53K8hDzje6S20KttmaT65X4ftQwAcUfIIGF5cuUMkEABaubvPsAPq5boQ8y@xvXFjJdropcr41G/CH5wt6AKO2VmgVu@wuWSOuW252z4mIAcCV3zxBPgv@G6f3DzGwAzf87hGe5kO/@xdkzq7p@zgYyQMV3uOAAd9OfaRlS0zwYGv/QIT4PhJCG/ahWCIAWTPG3FNRjB9QyvjObQC4p38gH3DysPg/AOLGOpdoqqoH1rXy54G9QBkUrHp9hgkXshnK3AfUW3k61WVt//tqKXp4lsfhw3O7nltceW6B5nE4mYVxPOnFEFBZ0G2PoGKrSuv3Q@zIymFkK8@uavNZ6BTxsKq1kgMIrnCsEv0eLbHGdxOFY7x@9ZaJnPoekRrSwUnb@EAE7iXayW1RSFe3ywLPuDetH/kB/0KOhng@2NJZmHqZOeeMP/qf3QuZkFnGrLJdsAPOW6U7vODosA/guwFzjks/AtYscleFfhD@JAVFM3Qm7b5wDUvmF7wcn@c7dHBr1ReI@mB8tiKuI9J6ZmznlCYDcmO75Z4Y4QjslukvRMfI3F2K/1237ta95NrC5cx5vmj7mmvZwRunAG7ru/sWc1cwtmbzP2FqZ4xBAmBC/rBvc/00/fwb" rel="noreferrer">Ungolfed</a>.</p>
<p>I only sorta understand this, but here's the basic algorithm the code follows:</p>
<ul>
<li><p>Convert the string to a list of characters for easier manipulation.</p>
</li>
<li><p>Parse the string into a list of tokens</p>
<ul>
<li>Parentheses are left on their own, other tokens are grouped into lists.</li>
</ul>
</li>
<li><p>Iterate through the string, keeping a list of the previous tokens:</p>
<ul>
<li>If it's a <code>)</code>, immediately append it. Else:</li>
<li>If:
<ul>
<li>Backtrack through the previous tokens to the start of the parent expression.</li>
<li>Use this index to get the depth of the parent expression, is it less than 3?</li>
</ul>
</li>
<li><em>or</em>:
<ul>
<li>Backtrack to the parent expression</li>
<li>Remove the first parenthesis and remove the first expression after that.</li>
<li>Is it empty?</li>
<li><em>and</em>:
<ul>
<li>is the current expression depth less than 2?</li>
</ul>
</li>
</ul>
</li>
<li>If so, this token should go on the same line, possibly with a space.</li>
<li>Else, it should be on a new line - get the depth of the current expression and indent by that.</li>
</ul>
</li>
<li><p>Finally, return the string.</p>
</li>
</ul>
</div>
<div id="pu3" class="pu"><h1>Python 3, 388 bytes</h1>
<p>Basically a golfed version of the reference solution @DLosc gave</p>
<pre class="lang-py prettyprint-override"><code>import re
k=&quot; &quot;
def p(e,*t,l=0):
 for n in e:
  if&quot;)&quot;==n:break
  if&quot;)&quot;&gt;n:z=p(e);l=max(l,z[0]+1);t+=z,
  else:l=max(l,1);t+=n,
 return[l,*t]
t=p(iter(re.findall(&quot;[^() ]+|\S&quot;,input())[1:]))
def f(t,d=k):
 if[*t]==t:
  r=&quot;(&quot;;s=[f(i,d+k)for i in t[1:]]
  if t[0]&gt;2:
   if len(t)&gt;2and&quot;&quot;in t[2]or t[2][0]&lt;2:r+=s[0]+k;s=s[1:]
   q=&quot;\n&quot;+d
  else:q=k
  return r+q.join(s)+&quot;)&quot;
 return t
print(f(t))
</code></pre>
<p><a href="https://tio.run/##NVHNboMwDL7zFFZO9kAVZTe69CV2pExiJWgZaQghlQDt3ZnDBhfj78fxl7glfA32ddv0ww0@gFdJLwWIpFUdOFTZS8iMzKlMoBs8WNAWFDegO0FCSlt@etX0B3C15SrZRhcjH82MJlurvE7PdAmpXDOWKTOp8iD/cMu4V@HpbWX4vDoJPEIH5dGrU6dt2xiDovpAgjr9ub2LTFv3DEhUncuaaN@1w5C1so@L6q7iKVKGuKeXAsVlklWHOmvTnmIMHWOE6K73zfk/r69F1MfOKIuBrkVjWyF2ZVGzKxbWvRWlT@UUc/U8eIpjonGU4mZF2h4hRxmv5S8Y@HQ8fQ/a4kQp39MRGELivLYBeX2ibcOWg4yIMyywgiPU/AgaDTjIiUUTzIwu2OxsHvn5Hz4TowuXlVvHNZILdiyYdnw3cTlYZvZTcuIP76y7s/4OK/4C" rel="nofollow noreferrer">Try it online!</a></p>
<p>The regex used in the code <code>[^() ]+|\S</code> is the a shorter way of writing the regex <code>[()]|[^() ]+</code> given in the question by 2 bytes</p>
<p><code>[*t]==t</code> is a sneaky trick to cut back 6 bytes instead of <code>type(t)==list</code></p>
<p><code>&quot;&quot;in t[2]</code> is another trick to cut down 7 bytes instead of <code>type(t[2])!=list</code></p>
<p>-3 thx to @pxeger</p>
<p>-1 thx to @aidenchow</p>
</div>
<div id="pu4" class="pu"><h1><a href="https://github.com/m-ender/retina/wiki/The-Language/a950ad7d925ec9316e3e2fb2cf5d49fd15d23e3d" rel="nofollow noreferrer">Retina 0.8.2</a>, 330 bytes</h1>
<pre><code>^((\()|(?&lt;-2&gt;\))|[^()])+
$&amp;$#2$*)
[^ (](?=\()|\)(?=[^) ])
$&amp; 
{%`^(( *)\(+?([^() ]+ |((\()|(?&lt;-5&gt;\))|[^()])+(?(5)^) )+)(\(([^() ]+ |\(\) )*\([^)])
$1¶$2 $6
 ¶
¶
%+`^(( *)\(([^() ]+|((\()|(?&lt;-5&gt;\))|[^()])+(?(5)^))( [^() ]+| \([^()]+\))+)( [^() ]+| \([^()]+\))+$
$1¶$2$7
%+`^(( *)\(([^() ]+|((\()|(?&lt;-5&gt;\))|[^()])+(?(5)^))\)) 
$1¶$2
</code></pre>
<p><a href="https://tio.run/##nVDNjpswEL77KUYpaWeCKgHStpe2HHLoOZe9xETrFJNaIoEAiUKa59oH2BdLZyghkdLVVrVAtr@/@aCyjduY8xi/P50XiBrphPGXj9E3TXSaL5AS8pX33nsXeRNS8wVggvFXkWniw3xBkBALQP0aP3EATEijH6NYIfHhdM18uM3EGB@IzeQTC65yjZrBiWaEJDh8efYi8D4peHlW/Iz9YcrF9MYIQrgIQXeexGeV/xru9UO9z/8zjCHoA85nJIV5YVLI3bIyVatwiyFEsmFIKAf4MBqNtEJZClOYCjeDR0IHM3SYwwwCCvj2iAanWDP6k2lixZTPjZwpIAo5Ywu4AvzRPVvYEqzo7kqy4N@lJK0yaXWAFo5QSrOya1ZyM8y40oHRFk3HBsIfepg/0rArpCNfS96FbDFjQd3hnYm3C8tMNyWQyVzmwG/L71F@js3A7u0mBszNepkawM1uzT1Tt3eprWOIQICuMmuLNL2TbormL/reMOCDSZC6qGC9yxtX5pYTXMYpdmUat7cx9ILbEsJe8VedN8RgvYzrIgZBb81tXV9tN5OPtireyKt3y@je@mf9Bg" rel="nofollow noreferrer" title="Retina 0.8.2 – Try It Online">Try it online!</a> Link includes test cases. Explanation:</p>
<pre><code>^((\()|(?&lt;-2&gt;\))|[^()])+
$&amp;$#2$*)
</code></pre>
<p>Use a .NET balancing group to count how many extra <code>(</code>s there are and append that many trailing <code>)</code>s.</p>
<pre><code>[^ (](?=\()|\)(?=[^) ])
$&amp; 
</code></pre>
<p>Insert spaces before <code>(</code>s and after <code>)</code>s where necessary.</p>
<pre><code>{`
</code></pre>
<p>Repeat until no more transforms can be made.</p>
<pre><code>%`^(( *)\(+?([^() ]+ |((\()|(?&lt;-5&gt;\))|[^()])+(?(5)^) )+)(\(([^() ]+ |\(\) )*\([^)])
$1¶$2 $6
 ¶
¶
</code></pre>
<p>Split lists of nesting level 3 or more.</p>
<pre><code>%+`^(( *)\(([^() ]+|((\()|(?&lt;-5&gt;\))|[^()])+(?(5)^))( [^() ]+| \([^()]+\))+)( [^() ]+| \([^()]+\))+$
$1¶$2$7
</code></pre>
<p>For those lists, where there are only lists of nesting level 0 or 1 left, put all but the first on their own line. (We need to check explicitly to ensure that the list was in fact split in the first place.)</p>
<pre><code>%+`^(( *)\(([^() ]+|((\()|(?&lt;-5&gt;\))|[^()])+(?(5)^))\)) 
$1¶$2
</code></pre>
<p>Lists of nesting level 0 or 1 after a list of nesting level 2 or more also need to go on their own line. (We know they can't have also nesting level 2 or more because they would have been split off earlier, so we don't actually need to check their nesting level.)</p>
</div>
<div id="pu5" class="pu"><h1><a href="https://github.com/somebody1234/Charcoal" rel="nofollow noreferrer">Charcoal</a>, 166 bytes</h1>
<pre><code>⊞υ⟦⟧≔ωηＦ⁺θ×)⁻№θ(№θ)«Ｆ№( )ιＦ›ηω«⊞§υ±¹⟦η¹⟧≔ωη»≡ι ω(⊞υ⟦⟧)«≔∨⊟υ⟦⟦ω⁰⟧⟧ι≔∧⊖Ｌι›³§§ι¹±¹δ≔⌈Ｅι⊕⊟κζＦ›⁴ζ≔⊖Ｌιδ≔Ｅ§ι⁰⁺§ (¬λκεＦδ⊞ε⁺⁺⊟ε ⊟§ι⊕κＦΦι›λδＦκ⊞ε⁺ λ⊞ε⁺⊟ε)⊞εζ⊞§υ±¹ε»≔⁺ηιη»✂⊟⊟υ⁰±¹
</code></pre>
<p><a href="https://tio.run/##dVLBbqMwED3DV4w4jSVWIto9tadoV60qbdtI21uUAzImWHGAYmgIVb@dzhhYoFI5YPnNm3lvxiOzuJJFbPp@19gMmxD2B3Hrb63VxxwvIWR0S4sKcGcai68hvOizshiIIIRHnRP2u2jymiMBoSHMVxEI/uDd91yFIRIgcK6mgEPvKxXXqsIshMtA9pyVbf2QJ6plS0/qSBTcCCq/J96GLXre2qT34Xv2omuZAWpXR8ZWQQDBDewqTcoXZg0gMrhseMQF4e9z6ecKd0WJDevuSSc6HARbX6hv8wT/KFmps8prleBflR/rjBwQcWrtZwhTN9OpqQux7Iz5ybLwY9zqc3Oms2T2Qz5rsKfTkNK5lNUgfzEqYCzznbcvWuXSWURx99wTFgDSkz0VNRrOPfFPzcqJGIapxrThRyYV8egBuFyxUlh24zqZi91pw13oeXyG3U7rcvqiReVDMEP@2sSkz2u4jHbz7ZsdU@M6JSqNG1PfTLN0dTNegP8r9@EPu/XPaKmc5rAwxIhWz3vb95hAiq@ILVyhg1KgBnpaNFDSxDFFCy2hV4xdNOJ4O8IbQeiVjo6uJZ0cvGJKBOtwl0THFKWIU4l4tiiJJ4kvoUO///FmPgE" rel="nofollow noreferrer" title="Charcoal – Try It Online">Try it online!</a> Link is to verbose version of code. Explanation:</p>
<pre><code>⊞υ⟦⟧
</code></pre>
<p>Add a dummy container to the predefined empty list to hold the final result.</p>
<pre><code>≔ωη
</code></pre>
<p>Start off with no atom.</p>
<pre><code>Ｆ⁺θ×)⁻№θ(№θ)«
</code></pre>
<p>Append enough trailing <code>)</code>s to balance the input and loop over its characters.</p>
<pre><code>Ｆ№( )ιＦ›ηω«⊞§υ±¹⟦η¹⟧≔ωη»
</code></pre>
<p>If the current character is one of <code>( )</code> then push any current token to the most recent expression. (Note that my nesting levels are one greater than those used by the question, because the nesting level of <code>()</code> evaluates to <code>1</code>.)</p>
<pre><code>≡ι ω
</code></pre>
<p>If the current character is a space then do nothing more at this point.</p>
<pre><code>(⊞υ⟦⟧
</code></pre>
<p>If the current character is a <code>(</code> then start a new subexpression.</p>
<pre><code>)«
</code></pre>
<p>If the current character is a <code>)</code>:</p>
<pre><code>≔∨⊟υ⟦⟦ω⁰⟧⟧ι
</code></pre>
<p>Get the latest expression, or an empty token if there wasn't one. (Since this makes <code>()</code> contain an empty token with a nesting level of <code>0</code>, its nesting level evaluates to <code>1</code>.)</p>
<pre><code>≔∧⊖Ｌι›³§§ι¹±¹δ
</code></pre>
<p>Calculate whether the second term should be concatenated to the end of the first.</p>
<pre><code>≔⌈Ｅι⊕⊟κζ
</code></pre>
<p>Calculate the depth of this term.</p>
<pre><code>Ｆ›⁴ζ≔⊖Ｌιδ
</code></pre>
<p>If this term is shallow enough then concatenate all the terms together.</p>
<pre><code>≔Ｅ§ι⁰⁺§ (¬λκε
</code></pre>
<p>Indent the first term, except for the first line, which is prefixed with a leading <code>(</code> instead.</p>
<pre><code>Ｆδ⊞ε⁺⁺⊟ε ⊟§ι⊕κ
</code></pre>
<p>Concatenate the desired number of terms to the first term.</p>
<pre><code>ＦΦι›λδＦκ⊞ε⁺ λ
</code></pre>
<p>Indent and append any remaining terms.</p>
<pre><code>⊞ε⁺⊟ε)
</code></pre>
<p>Append a final <code>)</code> to the last line.</p>
<pre><code>⊞εζ
</code></pre>
<p>Append the nesting level to this term.</p>
<pre><code>⊞§υ±¹ε
</code></pre>
<p>Append this term to its parent expression.</p>
<pre><code>»≔⁺ηιη
</code></pre>
<p>For any other character, append it to the current token.</p>
<pre><code>»✂⊟⊟υ⁰±¹
</code></pre>
<p>Output the pretty-printed expression, excluding its nesting depth.</p>
</div>
<div id="pu6" class="pu"><h1>Python3, 629 bytes:</h1>
<pre class="lang-py prettyprint-override"><code>import re
d=lambda x,c=0:c if type(x)!=list or not x else max(d(i,c+1)for i in x)
def p(s):
 r=[];S=str.lstrip
 while s:
  if(c:=s[0])==')':s=S(s[1:]);break
  if c=='(':s=(l:=p(s[1:]))[1];r+=[l[0]]
  else:r+=[l:=re.findall('[^() ]+',s)[0]];s=S(s[len(l):])
 return r,S(s)
def f(r,t=0):
 j=lambda x:x if type(x)!=list else'()'
 k,s=[],0
 if all(d(i)&lt;2 for i in r):k=[f(i,t+1)if d(i)else j(i)for i in r]
 else:
  for i,a in enumerate(r):
   D=d(a);F=f(a,t+1)if D else j(a)
   if not i:k+=[F]
   elif i==1 and D&lt;2:k+=[F]
   else:k+=['\n'+' '*(t+1)+F]
 return'('+' '.join(k)+')'
g=lambda x:f(p(x+')'*((c:=x.count)('(')-c(')')))[0][0])
</code></pre>
<p><a href="https://tio.run/##jVNNb9pAEL37V0xz8UwgyNBLZbLKIVHuUaRegEoLXpMNi212TWr483TGfKVCJbXA9r735uutt9rUb2Xx/Ufldzu7rEpfgzdRppxeTjMNTXemknQGNod6Uxls6JtyNtRQeijKGhowLhhY6gYztN1Zp085UxZsAQ1FmcmhwkBpBF6NJsNXFWrfc3yzVQS/36wzEJjk/DhLVRglE1IqpjgN6hXDqJ9OaDj1Ri9aDcyYRCHRpao6CGjUnwx9R40ch09YKC2lLZAqb3q5LTLtHMajX0gw6cTdQKIc7ms4U6AjzsM9mnrtC/BdxvfN5@i7tUpkgPeTJ2lz6YfUjJHiCBbdwKN2k0hEUpeNofsBnHzxlC7UKGe7araLRSJobXznl7OMR2kn4YlasKsFNsV6abyuDXrpCuBJZahp@Kxy1MeMT3DIp0kkjMhm2XTBpjyLRcwzaJXqgy4yeLof/MVxVVnG4yLuxBDfouTtCLu3iDdB8N57aQtcUId3LJqf/cmxwkbAW5RtbXqzcl3UhBxGdzO@xUSyBbLdu8rbosY5intE0X4Z38W3g@S4EtKVOgNnp177zTXdCvswuC7APuF1CYzjm5ub8fiaSK5rfAaPUusFfhJaeEGLDl4goYRXP1HjIwZG35gmVjzyey3vlBD1r9ZdAc4BZ@1vBSuCOV0sSS74fyldnySXSRrYwBYqmaZqp6l4Gsx5jIbRDeqWTYRvDjAbrTmqT1teVvwUcoM5C0KLt0H8OLLMtFUS6YnbbPi/4f/2utV8Us2HKR4AD98g8inh2TL7YTMTHmAAAnwxJmcps@wiiRydy0xfpjpFnNIJEvgkL9eutpUznJsPIRZmrmv7YR7gIPjcuLBn/J@Rn4hT6LFcm@IkOIQ6E8I57FPlrfHlF/nCejq4DD19R7s/" rel="noreferrer">Try it online!</a></p>
</div>

<table id="st">
<!-- Popups content will be added here -->
</table>

<table id="at">
<!-- Popups content will be added here -->
</table>

</div>





  <div class="footer">
      <b><a class="nonewtab" href="../">GOLFSCORE/</a><a href="https://codegolf.stackexchange.com/questions/242257/">242257</a></b>
  </div>
<div class="footer-space">&nbsp;</div>



<script src="../c.js"> </script>
</body>
</html>




